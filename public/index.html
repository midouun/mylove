<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Private Cottage</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; overflow: hidden; height: 100vh; background: #000; }
        
        /* Ø§Ù„Ø®Ù„ÙÙŠØ© */
        .bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://media.giphy.com/media/3o7aD2saalBwwftBIY/giphy.gif') center/cover;
            opacity: 0.6; z-index: -1;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.8); z-index: 10; color: #fff;
        }
        input { padding: 10px; margin: 5px; border-radius: 20px; border: none; text-align: center; }
        button { padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; background: #ff4757; color: white; font-weight: bold; }

        /* Ø§Ù„Ø´Ø§Øª */
        #chat { display: none; flex-direction: column; height: 100%; }
        #msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 15px; color: #fff; word-wrap: break-word; }
        .mine { align-self: flex-end; background: linear-gradient(45deg, #6c5ce7, #a29bfe); border-bottom-left-radius: 0; }
        .theirs { align-self: flex-start; background: linear-gradient(45deg, #ff7675, #fab1a0); border-bottom-right-radius: 0; color: #333; }
        
        .controls { padding: 10px; background: rgba(0,0,0,0.7); display: flex; gap: 5px; align-items: center; }
        #txt { flex: 1; }
        .icon-btn { background: #333; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; }
        img { max-width: 200px; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="bg"></div>

    <div id="login">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â¤ï¸</h2>
        <input id="u" placeholder="Ø§Ù„Ø§Ø³Ù… (alaa / miloud)">
        <input id="p" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        <p id="err" style="color:red"></p>
    </div>

    <div id="chat">
        <div id="msgs"></div>
        <div class="controls">
            <button class="icon-btn" onclick="document.getElementById('f').click()">ğŸ“·</button>
            <button class="icon-btn" id="rec" ontouchstart="startRec()" ontouchend="stopRec()" onmousedown="startRec()" onmouseup="stopRec()">ğŸ¤</button>
            <input id="txt" type="text" placeholder="Ø§ÙƒØªØ¨...">
            <button class="icon-btn" onclick="send('text')">â¤</button>
            <input type="file" id="f" hidden accept="image/*" onchange="send('image')">
        </div>
    </div>

    <script>
        const socket = io();
        let user = '';
        let mediaRec, chunks = [];

        function login() {
            const u = document.getElementById('u').value.toLowerCase();
            const p = document.getElementById('p').value;
            socket.emit('login', { username: u, password: p });
        }

        socket.on('login_success', (d) => {
            user = d.username;
            document.getElementById('login').style.display = 'none';
            document.getElementById('chat').style.display = 'flex';
        });

        socket.on('login_error', (m) => document.getElementById('err').innerText = m);

        function send(type) {
            let content;
            if (type === 'text') {
                content = document.getElementById('txt').value;
                if (!content) return;
                document.getElementById('txt').value = '';
            } else if (type === 'image') {
                const reader = new FileReader();
                reader.onload = (e) => socket.emit('chat_message', { type, content: e.target.result, sender: user });
                reader.readAsDataURL(document.getElementById('f').files[0]);
                return;
            }
            socket.emit('chat_message', { type, content, sender: user });
        }

        navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
            mediaRec = new MediaRecorder(s);
            mediaRec.ondataavailable = e => chunks.push(e.data);
            mediaRec.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.onload = (e) => socket.emit('chat_message', { type: 'audio', content: e.target.result, sender: user });
                reader.readAsDataURL(blob);
                chunks = [];
            };
        });

        function startRec() { if(mediaRec) { mediaRec.start(); document.getElementById('rec').style.background = 'red'; } }
        function stopRec() { if(mediaRec) { mediaRec.stop(); document.getElementById('rec').style.background = '#333'; } }

        socket.on('new_message', (d) => {
            const div = document.createElement('div');
            div.className = `msg ${d.sender === user ? 'mine' : 'theirs'}`;
            if (d.type === 'text') div.innerText = d.content;
            else if (d.type === 'image') div.innerHTML = `<img src="${d.content}">`;
            else if (d.type === 'audio') div.innerHTML = `<audio controls src="${d.content}"></audio>`;
            
            document.getElementById('msgs').appendChild(div);
            document.getElementById('msgs').scrollTop = 99999;
        });
    </script>
</body>
</html>
